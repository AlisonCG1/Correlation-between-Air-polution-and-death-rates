---
title: "Air polution"
output: html_notebook
---
```{r}
library(readxl)
library(tidyverse)
library(sf)
library(ggplot2)
library(dplyr)
library(readxl)
library(hrbrthemes)
library(viridis)
library(forcats)
```
#reading in the datasets that will be used in this project. 

```{r}
air_pollution_us <- read.csv("data/pollution_us_2000_2016.csv")
```

```{r}
air_pollution_global <- read.csv("data/data.csv")
```

#the following datasets contain information of total population Nox and PM globally between 2003 - 2018

```{r}
population <- read_excel("data/aqdh-country-trends-major-air-pollutants-2003-2018.xlsx", sheet = "Population (GPWv4.11)" )
NOx_Population <- read_excel("data/aqdh-country-trends-major-air-pollutants-2003-2018.xlsx", sheet = "NOx Population-Weighted (ppm)")
PM_Pop <- read_excel("data/aqdh-country-trends-major-air-pollutants-2003-2018.xlsx", sheet = "PM Pop.-Weighted (kg m^-3)")
```

#Droping duplicates in the dataframes and unnecesary columns. 

```{r}
population <- population %>% filter(!duplicated(.))
population = subset(population, select = -c(code))
```

```{r}
NOx_Population  <- NOx_Population %>% filter(!duplicated(.))
NOx_Population  = subset(NOx_Population, select = -c(code))
```

```{r}
PM_Pop  <- PM_Pop %>% filter(!duplicated(.))
PM_Pop  = subset(PM_Pop, select = -c(code))
```

#Reshaping the dataframes into a large table.

```{r}
population <- population%>%
 pivot_longer(cols = c('2003', '2004', '2005', '2006', '2007', '2008', '2009', '2010', '2011', '2012', '2013', '2014', '2015', '2016', '2017', '2018'),
               names_to = 'year',
               values_to = 'population')
```

```{r}
NOx_Population <- NOx_Population%>%
  pivot_longer(cols = c('2003', '2004', '2005', '2006', '2007', '2008', '2009', '2010', '2011', '2012', '2013', '2014', '2015', '2016', '2017', '2018'),
               names_to = 'year',
               values_to = 'nox')

```

```{r}
PM_Pop <- PM_Pop%>%
  pivot_longer(cols = c('2003', '2004', '2005', '2006', '2007', '2008', '2009', '2010', '2011', '2012', '2013', '2014', '2015', '2016', '2017', '2018'),
               names_to = 'year',
               values_to = 'PM')
```

##This dataset corresponds to the overall air pollutants per country. 

#Merging the datasets into one dataframe. 
```{r}
all_population <- population %>%
  full_join(NOx_Population, by = c("iso", "country", "year"))%>%
  full_join(PM_Pop, by = c("iso","country", "year"))
all_population
```
#Top 5 countries with the highest levels of NOX.
```{r}
top_nox <- all_population %>%      
  arrange(nox) %>% 
  group_by(year) %>%
  slice(1:5)
top_nox
```
# Plot the findings. 
```{r}
ggplot(top_nox, aes(year, nox, colour = country)) + 
  geom_point()
```
#Top 5 countries with PM. 
```{r}
top_pm <- all_population %>%      
  arrange(PM) %>% 
  group_by(year) %>%
  slice(1:5)
top_pm
```
#plot the findings. 
```{r}
ggplot(top_pm, aes(year, PM, colour = country)) + 
  geom_point()
```
#Multilinear regression to identify the relationship between the data.
```{r}
population_model <- lm(population ~ nox + PM, data = all_population)
summary(population_model)
```

#Fitting the log odds to have a better understanding of the relationship between variables.  
```{r}
log_population <- lm(log(population) ~ nox + PM, data = all_population)
summary(log_population)
```

##Global data comparing countries with the highest deaths caused by PM. 

#Dropping extra information that is not needed.
```{r}
air_pollution_global
```
#Dropping duplicates 
```{r}
air_pollution_global <- air_pollution_global%>% filter(!duplicated(.))
```

```{r}
air_pollution_filtered_gbl <- subset(air_pollution_global, select = -c(IndicatorCode, ValueType, 
Location.type, Period.type, IsLatestYear, Dim1.type, Dim1ValueCode, Dim2.type, Dim2ValueCode, Dim3.type, Dim3, Dim3ValueCode, DataSourceDimValueCode, DataSource, FactValueNumericPrefix, FactValueUoM, FactValueNumericLowPrefix, FactValueNumericLow, FactValueNumericHighPrefix, FactValueNumericHigh, FactValueTranslationID, FactComments, Language, DateModified))
air_pollution_filtered_gbl
```
#Renaming columns in the Global Dataframe.
```{r}
air_pollution_filtered_gbl <- air_pollution_filtered_gbl%>%
  transmute(
    continent = ParentLocation,
    country = Location,
    year = Period,
    sex = Dim1, 
    cause_of_death = Dim2,
    death_rates = FactValueNumeric
  )

air_pollution_filtered_gbl

```  

#filtering out the rows with "Total" in them. 
```{r}
air_pollution_filtered_gbl <- air_pollution_filtered_gbl%>%
  filter(cause_of_death != "Total")
``` 


#cheching the type of death causes in the dataframe

```{r}
air_pollution_filtered_gbl%>%
  count(cause_of_death, continent)
  
```

```{r}
summary(air_pollution_filtered_gbl[ , c('death_rates')])
```


#Top continents with the most deaths caused by air pollution.
```{r}
top_continent <- air_pollution_filtered_gbl %>%                                     
  # Top N highest values by group
  arrange(desc(death_rates))%>% 
  group_by(continent) %>%
  slice(1:5)
top_continent
```
 
```{r}
library(gapminder)
top_continent_plot <- top_continent %>% filter(year=="2019") %>% dplyr::select(-year)

top_continent_plot%>%
  arrange(desc(death_rates)) %>%
   group_by(continent) %>%
  ggplot(aes(x=continent, y=cause_of_death, size=death_rates, fill=continent)) +
  theme(axis.text.x=element_text(color = "black", size=8, angle=30, vjust=.8, hjust=0.8))+
    geom_point(alpha=0.5, shape=21, color="black") +
    scale_size(range = c(.1, 15), name="Death Rates per Continent")+
   ylab("cause of death") +
    xlab("Death rates per continent") +
    theme(legend.position = "right")


```

```{r}
top_country_dr <- air_pollution_filtered_gbl %>%                                     
  # Top N highest values by group
  arrange(desc(death_rates))%>% 
  group_by(country) %>%
  slice(1:5)

top_country_dr
``` 
 
```{r}
top_country_plot <- top_continent %>% filter(year=="2019") %>% dplyr::select(-year)

top_continent_plot%>%
  arrange(desc(death_rates)) %>%
   group_by(country) %>%
  ggplot(aes(x=cause_of_death, y=country, size=death_rates, fill=country)) +
  theme(axis.text.x=element_text(color = "black", size=8, angle=30, vjust=.9, hjust=0.8))+
    geom_point(alpha=0.5, shape=21, color="black") +
    scale_size(range = c(.1, 15), name="Death Rates per Continent")+
   ylab("cause of death") +
    xlab("Death rates per country") +
    theme(legend.position = "right")


``` 
#Statistical model. 
```{r}
model_gbl <- lm(death_rates ~ continent, data= air_pollution_filtered_gbl)
summary(model_gbl)
```

##The following dataset presents the levels of air pollutants in the USA. 
```{r}
air_pollution_us 
```
```{r}
air_pollution_us[!duplicated(air_pollution_us$Site.Num), ]
```


